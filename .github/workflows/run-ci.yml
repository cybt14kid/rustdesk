name: Full Flutter CI

on:
  # 允许在 GitHub Actions 页面手动点击 Run workflow
  workflow_dispatch:

  # 仍然支持通过 tag 自动触发
  push:
    tags:
      - 'v*'
      - 'v*-custom'

jobs:

  windows:
    name: Windows Build
    runs-on: windows-2022

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup vcpkg (no cache)
        uses: lukka/run-vcpkg@v11
        with:
          use-cache: false

      - name: Install build tools
        run: |
          choco install visualstudio2019buildtools --yes
          choco install cmake --yes
          choco install ninja --yes

      - name: Build Windows x64 RustDesk
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\windows_build.ps1

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-windows-x64
          path: |
            build/windows/RustDesk.exe

  android:
    name: Android Build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Build Android APK
        run: |
          flutter pub get
          flutter build apk --release

      - name: Upload Android artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-android
          path: build/app/outputs/flutter-apk/app-release.apk

  linux:
    name: Linux Build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential ninja-build pkg-config

      - name: Build Linux RustDesk
        run: |
          mkdir -p build/linux
          cd build/linux
          cmake ../../
          ninja

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-linux
          path: build/linux/rustdesk
