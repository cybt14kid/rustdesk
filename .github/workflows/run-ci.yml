name: Full Flutter CI

on:
  # 推送 tag 自动触发
  push:
    tags:
      - 'v*'
      - 'v*-custom'

  # 允许在 Actions 页面手动点击 Run
  workflow_dispatch:

jobs:
  windows:
    name: Windows Build (x64)
    runs-on: windows-2022

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          use-cache: false

      - name: Install build dependencies
        run: |
          choco install ninja --yes
          choco install cmake --yes

      - name: Build Windows x64 RustDesk
        shell: powershell
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          ./scripts/windows_build.ps1

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows-x64
          path: build/windows/RustDesk.exe

  android:
    name: Android Build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Build Android APK
        run: |
          flutter pub get
          flutter build apk --release

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android
          path: build/app/outputs/flutter-apk/app-release.apk

  linux:
    name: Linux Build
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            build-essential \
            ninja-build \
            pkg-config

      - name: Build Linux
        run: |
          mkdir -p build/linux
          cd build/linux
          cmake ../..
          ninja

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux
          path: build/linux/rustdesk
