name: Full Flutter CI

on:
  push:
    tags:
      - 'v*'
      - 'v*-custom'  # 你的自定义 tag 触发

jobs:

  windows:
    name: Windows Build
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          use-cache: false   # 禁用 cache，避免之前的失败

      - name: Install MSVC build tools
        run: |
          choco install visualstudio2019buildtools --yes
          choco install ninja --yes
          choco install cmake --yes

      - name: Build Windows x64 RustDesk
        run: |
          powershell -ExecutionPolicy Bypass -File .\scripts\windows_build.ps1

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-windows
          path: build/windows/RustDesk.exe

  android:
    name: Android Build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.13.0'

      - name: Build Android
        run: |
          flutter pub get
          flutter build apk --release
          
      - name: Upload Android artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-android
          path: build/app/outputs/flutter-apk/app-release.apk

  linux:
    name: Linux Build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake build-essential ninja-build pkg-config

      - name: Build Linux
        run: |
          mkdir -p build/linux
          cd build/linux
          cmake ../../
          ninja

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v3
        with:
          name: rustdesk-linux
          path: build/linux/rustdesk
